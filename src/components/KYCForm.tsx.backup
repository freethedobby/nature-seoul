"use client";

import { useState } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import * as z from "zod";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Label } from "@/components/ui/label";
import { Loader2, CheckCircle, AlertCircle, ImagePlus, X } from "lucide-react";
import { db } from "@/lib/firebase";
import {
  serverTimestamp,
  setDoc,
  doc as firestoreDoc,
} from "firebase/firestore";

import { useAuth } from "@/contexts/AuthContext";
import { cn } from "@/lib/utils";
import Image from "next/image";
import { createNotification, notificationTemplates } from "@/lib/notifications";

// ì „êµ­ ì‹œë„ë³„ ì‹œêµ°êµ¬ ë°ì´í„°
const districts = {
  seoul: [
    { value: "gangnam", label: "ê°•ë‚¨êµ¬" },
    { value: "gangdong", label: "ê°•ë™êµ¬" },
    { value: "gangbuk", label: "ê°•ë¶êµ¬" },
    { value: "gangseo", label: "ê°•ì„œêµ¬" },
    { value: "gwanak", label: "ê´€ì•…êµ¬" },
    { value: "gwangjin", label: "ê´‘ì§„êµ¬" },
    { value: "guro", label: "êµ¬ë¡œêµ¬" },
    { value: "geumcheon", label: "ê¸ˆì²œêµ¬" },
    { value: "nowon", label: "ë…¸ì›êµ¬" },
    { value: "dobong", label: "ë„ë´‰êµ¬" },
    { value: "dongdaemun", label: "ë™ëŒ€ë¬¸êµ¬" },
    { value: "dongjak", label: "ë™ì‘êµ¬" },
    { value: "mapo", label: "ë§ˆí¬êµ¬" },
    { value: "seodaemun", label: "ì„œëŒ€ë¬¸êµ¬" },
    { value: "seocho", label: "ì„œì´ˆêµ¬" },
    { value: "seongbuk", label: "ì„±ë¶êµ¬" },
    { value: "songpa", label: "ì†¡íŒŒêµ¬" },
    { value: "yangcheon", label: "ì–‘ì²œêµ¬" },
    { value: "yeongdeungpo", label: "ì˜ë“±í¬êµ¬" },
    { value: "yongsan", label: "ìš©ì‚°êµ¬" },
    { value: "eunpyeong", label: "ì€í‰êµ¬" },
    { value: "jongno", label: "ì¢…ë¡œêµ¬" },
    { value: "junggu", label: "ì¤‘êµ¬" },
    { value: "jungnang", label: "ì¤‘ë‘êµ¬" },
  ],
  busan: [
    { value: "junggu_busan", label: "ì¤‘êµ¬" },
    { value: "seogu", label: "ì„œêµ¬" },
    { value: "donggu_busan", label: "ë™êµ¬" },
    { value: "yeongdo", label: "ì˜ë„êµ¬" },
    { value: "busanjin", label: "ë¶€ì‚°ì§„êµ¬" },
    { value: "dongnae", label: "ë™ë˜êµ¬" },
    { value: "namgu_busan", label: "ë‚¨êµ¬" },
    { value: "bukgu_busan", label: "ë¶êµ¬" },
    { value: "haeundae", label: "í•´ìš´ëŒ€êµ¬" },
    { value: "saha", label: "ì‚¬í•˜êµ¬" },
    { value: "geumjeong", label: "ê¸ˆì •êµ¬" },
    { value: "gangseo_busan", label: "ê°•ì„œêµ¬" },
    { value: "yeonje", label: "ì—°ì œêµ¬" },
    { value: "suyeong", label: "ìˆ˜ì˜êµ¬" },
    { value: "sasang", label: "ì‚¬ìƒêµ¬" },
    { value: "gijang", label: "ê¸°ì¥êµ°" },
  ],
  daegu: [
    { value: "junggu_daegu", label: "ì¤‘êµ¬" },
    { value: "donggu_daegu", label: "ë™êµ¬" },
    { value: "seogu_daegu", label: "ì„œêµ¬" },
    { value: "namgu_daegu", label: "ë‚¨êµ¬" },
    { value: "bukgu_daegu", label: "ë¶êµ¬" },
    { value: "suseong", label: "ìˆ˜ì„±êµ¬" },
    { value: "dalseo", label: "ë‹¬ì„œêµ¬" },
    { value: "dalseong", label: "ë‹¬ì„±êµ°" },
  ],
  incheon: [
    { value: "junggu_incheon", label: "ì¤‘êµ¬" },
    { value: "donggu_incheon", label: "ë™êµ¬" },
    { value: "michuhol", label: "ë¯¸ì¶”í™€êµ¬" },
    { value: "yeonsu", label: "ì—°ìˆ˜êµ¬" },
    { value: "namdong", label: "ë‚¨ë™êµ¬" },
    { value: "bupyeong", label: "ë¶€í‰êµ¬" },
    { value: "gyeyang", label: "ê³„ì–‘êµ¬" },
    { value: "seo_incheon", label: "ì„œêµ¬" },
    { value: "ganghwa", label: "ê°•í™”êµ°" },
    { value: "ongjin", label: "ì˜¹ì§„êµ°" },
  ],
  gwangju: [
    { value: "donggu_gwangju", label: "ë™êµ¬" },
    { value: "seogu_gwangju", label: "ì„œêµ¬" },
    { value: "namgu_gwangju", label: "ë‚¨êµ¬" },
    { value: "bukgu_gwangju", label: "ë¶êµ¬" },
    { value: "gwangsan", label: "ê´‘ì‚°êµ¬" },
  ],
  daejeon: [
    { value: "donggu_daejeon", label: "ë™êµ¬" },
    { value: "junggu_daejeon", label: "ì¤‘êµ¬" },
    { value: "seogu_daejeon", label: "ì„œêµ¬" },
    { value: "yuseong", label: "ìœ ì„±êµ¬" },
    { value: "daedeok", label: "ëŒ€ë•êµ¬" },
  ],
  ulsan: [
    { value: "junggu_ulsan", label: "ì¤‘êµ¬" },
    { value: "namgu_ulsan", label: "ë‚¨êµ¬" },
    { value: "donggu_ulsan", label: "ë™êµ¬" },
    { value: "bukgu_ulsan", label: "ë¶êµ¬" },
    { value: "ulju", label: "ìš¸ì£¼êµ°" },
  ],
  sejong: [{ value: "sejong", label: "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ" }],
  gyeonggi: [
    { value: "suwon", label: "ìˆ˜ì›ì‹œ" },
    { value: "seongnam", label: "ì„±ë‚¨ì‹œ" },
    { value: "bucheon", label: "ë¶€ì²œì‹œ" },
    { value: "anyang", label: "ì•ˆì–‘ì‹œ" },
    { value: "ansan", label: "ì•ˆì‚°ì‹œ" },
    { value: "pyeongtaek", label: "í‰íƒì‹œ" },
    { value: "siheung", label: "ì‹œí¥ì‹œ" },
    { value: "gwangmyeong", label: "ê´‘ëª…ì‹œ" },
    { value: "gwangju_gyeonggi", label: "ê´‘ì£¼ì‹œ" },
    { value: "yongin", label: "ìš©ì¸ì‹œ" },
    { value: "paju", label: "íŒŒì£¼ì‹œ" },
    { value: "icheon", label: "ì´ì²œì‹œ" },
    { value: "anseong", label: "ì•ˆì„±ì‹œ" },
    { value: "gimpo", label: "ê¹€í¬ì‹œ" },
    { value: "hwaseong", label: "í™”ì„±ì‹œ" },
    { value: "yeoju", label: "ì—¬ì£¼ì‹œ" },
    { value: "pocheon", label: "í¬ì²œì‹œ" },
    { value: "dongducheon", label: "ë™ë‘ì²œì‹œ" },
    { value: "goyang", label: "ê³ ì–‘ì‹œ" },
    { value: "namyangju", label: "ë‚¨ì–‘ì£¼ì‹œ" },
    { value: "osan", label: "ì˜¤ì‚°ì‹œ" },
    { value: "hanam", label: "í•˜ë‚¨ì‹œ" },
    { value: "uijeongbu", label: "ì˜ì •ë¶€ì‹œ" },
    { value: "yangju", label: "ì–‘ì£¼ì‹œ" },
    { value: "gunpo", label: "êµ°í¬ì‹œ" },
    { value: "uiwang", label: "ì˜ì™•ì‹œ" },
    { value: "gwachon", label: "ê³¼ì²œì‹œ" },
    { value: "guri", label: "êµ¬ë¦¬ì‹œ" },
    { value: "yeoncheon", label: "ì—°ì²œêµ°" },
    { value: "gapyeong", label: "ê°€í‰êµ°" },
    { value: "yangpyeong", label: "ì–‘í‰êµ°" },
  ],
  gangwon: [
    { value: "chuncheon", label: "ì¶˜ì²œì‹œ" },
    { value: "wonju", label: "ì›ì£¼ì‹œ" },
    { value: "gangneung", label: "ê°•ë¦‰ì‹œ" },
    { value: "donghae", label: "ë™í•´ì‹œ" },
    { value: "taebaek", label: "íƒœë°±ì‹œ" },
    { value: "sokcho", label: "ì†ì´ˆì‹œ" },
    { value: "samcheok", label: "ì‚¼ì²™ì‹œ" },
    { value: "hongcheon", label: "í™ì²œêµ°" },
    { value: "hoengseong", label: "íš¡ì„±êµ°" },
    { value: "yeongwol", label: "ì˜ì›”êµ°" },
    { value: "pyeongchang", label: "í‰ì°½êµ°" },
    { value: "jeongseon", label: "ì •ì„ êµ°" },
    { value: "cheorwon", label: "ì² ì›êµ°" },
    { value: "hwacheon", label: "í™”ì²œêµ°" },
    { value: "yanggu", label: "ì–‘êµ¬êµ°" },
    { value: "inje", label: "ì¸ì œêµ°" },
    { value: "goseong_gangwon", label: "ê³ ì„±êµ°" },
    { value: "yangyang", label: "ì–‘ì–‘êµ°" },
  ],
  chungbuk: [
    { value: "cheongju", label: "ì²­ì£¼ì‹œ" },
    { value: "chungju", label: "ì¶©ì£¼ì‹œ" },
    { value: "jecheon", label: "ì œì²œì‹œ" },
    { value: "boeun", label: "ë³´ì€êµ°" },
    { value: "okcheon", label: "ì˜¥ì²œêµ°" },
    { value: "yeongdong", label: "ì˜ë™êµ°" },
    { value: "jincheon", label: "ì§„ì²œêµ°" },
    { value: "goesan", label: "ê´´ì‚°êµ°" },
    { value: "eumseong", label: "ìŒì„±êµ°" },
    { value: "danyang", label: "ë‹¨ì–‘êµ°" },
    { value: "jeungpyeong", label: "ì¦í‰êµ°" },
  ],
  chungnam: [
    { value: "cheonan", label: "ì²œì•ˆì‹œ" },
    { value: "gongju", label: "ê³µì£¼ì‹œ" },
    { value: "boryeong", label: "ë³´ë ¹ì‹œ" },
    { value: "asan", label: "ì•„ì‚°ì‹œ" },
    { value: "seosan", label: "ì„œì‚°ì‹œ" },
    { value: "nonsan", label: "ë…¼ì‚°ì‹œ" },
    { value: "gyeryong", label: "ê³„ë£¡ì‹œ" },
    { value: "dangjin", label: "ë‹¹ì§„ì‹œ" },
    { value: "geumsan", label: "ê¸ˆì‚°êµ°" },
    { value: "buyeo", label: "ë¶€ì—¬êµ°" },
    { value: "seocheon", label: "ì„œì²œêµ°" },
    { value: "cheongyang", label: "ì²­ì–‘êµ°" },
    { value: "hongseong", label: "í™ì„±êµ°" },
    { value: "yesan", label: "ì˜ˆì‚°êµ°" },
    { value: "taean", label: "íƒœì•ˆêµ°" },
  ],
  jeonbuk: [
    { value: "jeonju", label: "ì „ì£¼ì‹œ" },
    { value: "gunsan", label: "êµ°ì‚°ì‹œ" },
    { value: "iksan", label: "ìµì‚°ì‹œ" },
    { value: "jeongeup", label: "ì •ìì‹œ" },
    { value: "namwon", label: "ë‚¨ì›ì‹œ" },
    { value: "gimje", label: "ê¹€ì œì‹œ" },
    { value: "wanju", label: "ì™„ì£¼êµ°" },
    { value: "jangsu", label: "ì¥ìˆ˜êµ°" },
    { value: "imsil", label: "ì„ì‹¤êµ°" },
    { value: "sunchang", label: "ìˆœì°½êµ°" },
    { value: "jinan", label: "ì§„ì•ˆêµ°" },
    { value: "muju", label: "ë¬´ì£¼êµ°" },
    { value: "buan", label: "ë¶€ì•ˆêµ°" },
    { value: "gochang", label: "ê³ ì°½êµ°" },
  ],
  jeonnam: [
    { value: "mokpo", label: "ëª©í¬ì‹œ" },
    { value: "yeosu", label: "ì—¬ìˆ˜ì‹œ" },
    { value: "suncheon", label: "ìˆœì²œì‹œ" },
    { value: "naju", label: "ë‚˜ì£¼ì‹œ" },
    { value: "gwangyang", label: "ê´‘ì–‘ì‹œ" },
    { value: "damyang", label: "ë‹´ì–‘êµ°" },
    { value: "gokseong", label: "ê³¡ì„±êµ°" },
    { value: "gurye", label: "êµ¬ë¡€êµ°" },
    { value: "goheung", label: "ê³ í¥êµ°" },
    { value: "boseong", label: "ë³´ì„±êµ°" },
    { value: "hwaseong_jeonnam", label: "í™”ìˆœêµ°" },
    { value: "jangheung", label: "ì¥í¥êµ°" },
    { value: "gangjin", label: "ê°•ì§„êµ°" },
    { value: "haenam", label: "í•´ë‚¨êµ°" },
    { value: "yeongam", label: "ì˜ì•”êµ°" },
    { value: "muan", label: "ë¬´ì•ˆêµ°" },
    { value: "sinan", label: "ì‹ ì•ˆêµ°" },
    { value: "jindo", label: "ì§„ë„êµ°" },
    { value: "wando", label: "ì™„ë„êµ°" },
    { value: "jangsung", label: "ì¥ì„±êµ°" },
    { value: "hwasun", label: "í™”ìˆœêµ°" },
  ],
  gyeongbuk: [
    { value: "pohang", label: "í¬í•­ì‹œ" },
    { value: "gumi", label: "êµ¬ë¯¸ì‹œ" },
    { value: "gimcheon", label: "ê¹€ì²œì‹œ" },
    { value: "andong", label: "ì•ˆë™ì‹œ" },
    { value: "gyeongju", label: "ê²½ì£¼ì‹œ" },
    { value: "gyeongsan", label: "ê²½ì‚°ì‹œ" },
    { value: "yeongju", label: "ì˜ì£¼ì‹œ" },
    { value: "yeongcheon", label: "ì˜ì²œì‹œ" },
    { value: "sangju", label: "ìƒì£¼ì‹œ" },
    { value: "mungyeong", label: "ë¬¸ê²½ì‹œ" },
    { value: "chilgok", label: "ì¹ ê³¡êµ°" },
    { value: "yeongdeok", label: "ì˜ë•êµ°" },
    { value: "cheongdo", label: "ì²­ë„êµ°" },
    { value: "goryeong", label: "ê³ ë ¹êµ°" },
    { value: "seongju", label: "ì„±ì£¼êµ°" },
    { value: "chilgok", label: "ì¹ ê³¡êµ°" },
    { value: "gimcheon", label: "ê¹€ì²œì‹œ" },
    { value: "yeongyang", label: "ì˜ì–‘êµ°" },
    { value: "bonghwa", label: "ë´‰í™”êµ°" },
    { value: "uljin", label: "ìš¸ì§„êµ°" },
    { value: "ulleung", label: "ìš¸ë¦‰êµ°" },
  ],
  gyeongnam: [
    { value: "changwon", label: "ì°½ì›ì‹œ" },
    { value: "jinju", label: "ì§„ì£¼ì‹œ" },
    { value: "tongyeong", label: "í†µì˜ì‹œ" },
    { value: "sacheon", label: "ì‚¬ì²œì‹œ" },
    { value: "gimhae", label: "ê¹€í•´ì‹œ" },
    { value: "miryang", label: "ë°€ì–‘ì‹œ" },
    { value: "geoje", label: "ê±°ì œì‹œ" },
    { value: "yangsan", label: "ì–‘ì‚°ì‹œ" },
    { value: "ulsan_gyeongnam", label: "ìš¸ì‚°ì‹œ" },
    { value: "uiryeong", label: "ì˜ë ¹êµ°" },
    { value: "haman", label: "í•¨ì•ˆêµ°" },
    { value: "changnyeong", label: "ì°½ë…•êµ°" },
    { value: "goseong_gyeongnam", label: "ê³ ì„±êµ°" },
    { value: "namhae", label: "ë‚¨í•´êµ°" },
    { value: "hadong", label: "í•˜ë™êµ°" },
    { value: "sancheong", label: "ì‚°ì²­êµ°" },
    { value: "hamyang", label: "í•¨ì–‘êµ°" },
    { value: "geochang", label: "ê±°ì°½êµ°" },
    { value: "hapcheon", label: "í•©ì²œêµ°" },
  ],
  jeju: [
    { value: "jeju", label: "ì œì£¼ì‹œ" },
    { value: "seogwipo", label: "ì„œê·€í¬ì‹œ" },
  ],
  other: [{ value: "other", label: "ê¸°íƒ€" }],
};

const provinces = [
  { value: "seoul", label: "ì„œìš¸íŠ¹ë³„ì‹œ" },
  { value: "busan", label: "ë¶€ì‚°ê´‘ì—­ì‹œ" },
  { value: "daegu", label: "ëŒ€êµ¬ê´‘ì—­ì‹œ" },
  { value: "incheon", label: "ì¸ì²œê´‘ì—­ì‹œ" },
  { value: "gwangju", label: "ê´‘ì£¼ê´‘ì—­ì‹œ" },
  { value: "daejeon", label: "ëŒ€ì „ê´‘ì—­ì‹œ" },
  { value: "ulsan", label: "ìš¸ì‚°ê´‘ì—­ì‹œ" },
  { value: "sejong", label: "ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ" },
  { value: "gyeonggi", label: "ê²½ê¸°ë„" },
  { value: "gangwon", label: "ê°•ì›ë„" },
  { value: "chungbuk", label: "ì¶©ì²­ë¶ë„" },
  { value: "chungnam", label: "ì¶©ì²­ë‚¨ë„" },
  { value: "jeonbuk", label: "ì „ë¼ë¶ë„" },
  { value: "jeonnam", label: "ì „ë¼ë‚¨ë„" },
  { value: "gyeongbuk", label: "ê²½ìƒë¶ë„" },
  { value: "gyeongnam", label: "ê²½ìƒë‚¨ë„" },
  { value: "jeju", label: "ì œì£¼íŠ¹ë³„ìì¹˜ë„" },
  { value: "other", label: "ê¸°íƒ€" },
];

// Form validation schema
const kycSchema = z.object({
  privacyConsent: z.boolean().refine((val) => val === true, {
    message: "ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•´ì£¼ì„¸ìš”",
  }),
  name: z
    .string()
    .min(2, "ì´ë¦„ì€ 2ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”")
    .max(30, "ì´ë¦„ì€ 30ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”"),
  gender: z.enum(["male", "female", "other"], {
    required_error: "ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”",
  }),
  birthYear: z.string().min(4, "ì¶œìƒë…„ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”"),
  contact: z
    .string()
    .length(11, "ì—°ë½ì²˜ëŠ” 11ìë¦¬ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”")
    .regex(/^[0-9]+$/, "ìˆ«ìë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”"),
  province: z.enum(
    [
      "seoul",
      "busan",
      "daegu",
      "incheon",
      "gwangju",
      "daejeon",
      "ulsan",
      "sejong",
      "gyeonggi",
      "gangwon",
      "chungbuk",
      "chungnam",
      "jeonbuk",
      "jeonnam",
      "gyeongbuk",
      "gyeongnam",
      "jeju",
      "other",
    ],
    {
      required_error: "ì‹œë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”",
    }
  ),
  district: z.string().min(1, "ì‹œêµ°êµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”"),
  detailedAddress: z.string().optional(), // ìƒì„¸ì£¼ì†ŒëŠ” ì„ íƒí•­ëª©
  skinType: z.enum(
    ["oily", "dry", "normal", "combination", "unknown", "other"],
    {
      required_error: "í”¼ë¶€íƒ€ì…ì„ ì„ íƒí•´ì£¼ì„¸ìš”",
    }
  ),
  hasPreviousTreatment: z.enum(["yes", "no"], {
    required_error: "ê¸°ì¡´ ì‹œìˆ  ì—¬ë¶€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”",
  }),
  eyebrowPhotoLeft: z.instanceof(File).optional(), // ì¢Œì¸¡ ì‚¬ì§„
  eyebrowPhotoFront: z.instanceof(File).optional(), // ì •ë©´ ì‚¬ì§„
  eyebrowPhotoRight: z.instanceof(File).optional(), // ìš°ì¸¡ ì‚¬ì§„
});

type KYCFormData = z.infer<typeof kycSchema>;

interface KYCFormProps {
  onSuccess?: () => void;
}

export default function KYCForm({ onSuccess }: KYCFormProps) {
  const { user } = useAuth();
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitStatus, setSubmitStatus] = useState<
    "idle" | "success" | "error"
  >("idle");
  const [errorMessage, setErrorMessage] = useState<string>("");
  const [previewImages, setPreviewImages] = useState<{
    left: string | null;
    front: string | null;
    right: string | null;
  }>({ left: null, front: null, right: null });
  const [, setSelectedFiles] = useState<{
    left: File | null;
    front: File | null;
    right: File | null;
  }>({ left: null, front: null, right: null });
  const [isDragging, setIsDragging] = useState(false);

  const {
    register,
    handleSubmit,
    setValue,
    formState: { errors },
    reset,
    watch,
  } = useForm<KYCFormData>({
    resolver: zodResolver(kycSchema),
  });

  // Watch form values for debugging
  const watchedValues = watch();
  console.log("Form values:", watchedValues);
  console.log("Form errors:", errors);

  // Handle file change for specific photo type
  const handleFileChange =
    (photoType: "left" | "front" | "right") =>
    (event: React.ChangeEvent<HTMLInputElement>) => {
      const file = event.target.files?.[0];
      if (file) {
        setSelectedFiles((prev) => ({ ...prev, [photoType]: file }));
        setValue(
          `eyebrowPhoto${
            photoType.charAt(0).toUpperCase() + photoType.slice(1)
          }` as keyof KYCFormData,
          file
        );
        const reader = new FileReader();
        reader.onload = (e) => {
          setPreviewImages((prev) => ({
            ...prev,
            [photoType]: e.target?.result as string,
          }));
        };
        reader.readAsDataURL(file);
      }
    };

  // Handle file drop for specific photo type
  const handleDrop =
    (photoType: "left" | "front" | "right") =>
    (event: React.DragEvent<HTMLLabelElement>) => {
      event.preventDefault();
      setIsDragging(false);
      const file = event.dataTransfer.files[0];
      if (file) {
        setSelectedFiles((prev) => ({ ...prev, [photoType]: file }));
        setValue(
          `eyebrowPhoto${
            photoType.charAt(0).toUpperCase() + photoType.slice(1)
          }` as keyof KYCFormData,
          file
        );
        const reader = new FileReader();
        reader.onload = (e) => {
          setPreviewImages((prev) => ({
            ...prev,
            [photoType]: e.target?.result as string,
          }));
        };
        reader.readAsDataURL(file);
      }
    };

  const handleDragOver = (event: React.DragEvent<HTMLLabelElement>) => {
    event.preventDefault();
    setIsDragging(true);
  };

  const handleDragLeave = () => {
    setIsDragging(false);
  };

  // Compress image function
  const compressImage = (file: File): Promise<string> => {
    return new Promise((resolve, reject) => {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      const img = new window.Image();

      img.onload = () => {
        // Calculate new dimensions while maintaining aspect ratio
        let { width, height } = img;
        const maxDimension = 1200;

        if (width > height) {
          if (width > maxDimension) {
            height = (height * maxDimension) / width;
            width = maxDimension;
          }
        } else {
          if (height > maxDimension) {
            width = (width * maxDimension) / height;
            height = maxDimension;
          }
        }

        canvas.width = width;
        canvas.height = height;

        // Draw and compress
        ctx?.drawImage(img, 0, 0, width, height);
        canvas.toBlob(
          (blob) => {
            if (blob) {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result as string);
              reader.onerror = reject;
              reader.readAsDataURL(blob);
            } else {
              reject(new Error("Failed to compress image"));
            }
          },
          "image/jpeg",
          0.8
        );
      };

      img.onerror = reject;
      img.src = URL.createObjectURL(file);
    });
  };

  // Upload image function
  const uploadImage = async (file: File): Promise<string> => {
    try {
      console.log("=== UPLOAD IMAGE START ===");
      console.log("Original file:", file.name, file.size, file.type);

      // Skip Firebase Storage due to CORS issues and use Base64 directly
      console.log(
        "ğŸ”„ Using Base64 encoding (Firebase Storage CORS issues detected)"
      );

      // Compress and encode image
      console.log("Compressing and encoding image...");
      const compressedImageDataUrl = await compressImage(file);
      console.log("âœ… Image compressed and encoded successfully");

      return compressedImageDataUrl;
    } catch (error) {
      console.error("âŒ Image processing failed:", error);
      throw error;
    }
  };

  const onSubmit = async (data: KYCFormData) => {
    console.log("=== KYC SUBMISSION START ===");
    console.log("Form data:", data);
    console.log("User:", user?.email);
    console.log("Firebase db available:", !!db);

    // Handle both logged-in users and guests
    const isGuest = !user;
    const userId = user?.uid || "guest";
    const userEmail = user?.email || "guest@example.com";

    console.log("Setting isSubmitting to true");
    setIsSubmitting(true);
    setSubmitStatus("idle");

    // Add timeout to prevent infinite loading
    const timeoutId = setTimeout(() => {
      console.log("Submission timeout - forcing completion");
      setIsSubmitting(false);
      setSubmitStatus("error");
    }, 30000); // 30 second timeout

    try {
      // Check if Firebase is properly configured
      if (!db) {
        console.error("âŒ Firebase not configured");
        setSubmitStatus("error");
        return;
      }

      // Test Firebase connectivity
      console.log("=== TESTING FIREBASE CONNECTIVITY ===");
      console.log("Network status:", navigator.onLine);

      try {
        firestoreDoc(db, "test", "connectivity");
        console.log("âœ… Firestore doc reference created successfully");
      } catch (firestoreError) {
        console.error("âŒ Firestore doc reference failed:", firestoreError);
        if (!navigator.onLine) {
          throw new Error("ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }
        throw new Error("Firestore not accessible");
      }

      console.log("Starting image uploads...");

      // Upload all three images
      const imageUrls: { left: string; front: string; right: string } = {
        left: "",
        front: "",
        right: "",
      };

      const photoTypes = ["left", "front", "right"] as const;

      for (const photoType of photoTypes) {
        const photoKey = `eyebrowPhoto${
          photoType.charAt(0).toUpperCase() + photoType.slice(1)
        }` as keyof KYCFormData;
        const photoFile = data[photoKey] as File;

        if (!photoFile) {
          throw new Error(
            `${
              photoType === "left"
                ? "ì¢Œì¸¡"
                : photoType === "front"
                ? "ì •ë©´"
                : "ìš°ì¸¡"
            } ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.`
          );
        }

        try {
          console.log(
            `=== ${photoType.toUpperCase()} IMAGE UPLOAD ATTEMPT ===`
          );
          console.log("File to upload:", photoFile);
          console.log("File type:", photoFile?.type);
          console.log("File size:", photoFile?.size);

          const imageUrl = await uploadImage(photoFile);
          imageUrls[photoType] = imageUrl;
          console.log(
            `${photoType} image processed successfully, URL type:`,
            imageUrl.startsWith("data:") ? "base64" : "firebase-storage"
          );
        } catch (uploadError) {
          console.error(
            `=== ${photoType.toUpperCase()} IMAGE UPLOAD FAILED ===`
          );
          console.error("Upload error:", uploadError);
          console.error("Using fallback to base64...");

          // Fallback: convert to base64
          try {
            const imageUrl = await new Promise<string>((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result as string);
              reader.onerror = reject;
              reader.readAsDataURL(photoFile);
            });
            imageUrls[photoType] = imageUrl;
            console.log(`âœ… ${photoType} Base64 fallback successful`);
          } catch (base64Error) {
            console.error(
              `âŒ ${photoType} Base64 fallback also failed:`,
              base64Error
            );
            throw new Error(
              `${
                photoType === "left"
                  ? "ì¢Œì¸¡"
                  : photoType === "front"
                  ? "ì •ë©´"
                  : "ìš°ì¸¡"
              } ì‚¬ì§„ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`
            );
          }
        }
      }

      // Save to Firestore in users collection
      const userData = {
        userId: userId,
        email: userEmail,
        name: data.name,
        gender: data.gender,
        birthYear: data.birthYear,
        contact: data.contact,
        province: data.province,
        district: data.district,
        detailedAddress: data.detailedAddress || "",
        skinType: data.skinType,
        photoURLs: {
          left: imageUrls.left,
          front: imageUrls.front,
          right: imageUrls.right,
        },
        photoType: imageUrls.left.startsWith("data:")
          ? "base64"
          : "firebase-storage",
        kycStatus: "pending",
        hasPreviousTreatment: data.hasPreviousTreatment === "yes",
        createdAt: serverTimestamp(),
        submittedAt: serverTimestamp(),
        isGuest: isGuest,
      };

      console.log("Saving user data to Firestore...");
      console.log("User data to save:", userData);
      console.log("Document path: users/", userId);

      try {
        await setDoc(firestoreDoc(db, "users", userId), userData, {
          merge: true,
        });
        console.log("âœ… User data saved successfully with UID as doc ID");
        console.log("Document ID:", userId);
        console.log("KYC Status: pending");
      } catch (firestoreError) {
        console.error("âŒ Firestore save failed:", firestoreError);
        throw firestoreError;
      }

      console.log("Setting final success status");
      clearTimeout(timeoutId);
      setSubmitStatus("success");
      setIsSubmitting(false);
      reset();
      setPreviewImages({ left: null, front: null, right: null });
      setSelectedFiles({ left: null, front: null, right: null });

      // Create notifications
      try {
        // Create customer notification
        await createNotification({
          userId: userId,
          type: "kyc_submitted",
          title: "KYC ì‹ ì²­ ì™„ë£Œ",
          message:
            "KYC ì‹ ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤. ê²€í†  í›„ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.",
        });

        // Create admin notification for all admins
        const adminNotification = notificationTemplates.adminKycNew(
          data.name,
          userEmail
        );
        await createNotification({
          userId: "admin", // Special ID for admin notifications
          type: "admin_kyc_new",
          title: adminNotification.title,
          message: adminNotification.message,
          data: {
            customerName: data.name,
            customerEmail: userEmail,
            customerId: userId,
          },
        });
      } catch (notificationError) {
        console.error("Error creating notifications:", notificationError);
        // Don't fail the form submission if notifications fail
      }

      onSuccess?.();
    } catch (error) {
      console.error("=== KYC SUBMISSION ERROR ===");
      console.error("Error:", error);
      console.error("Error details:", {
        message: error instanceof Error ? error.message : "Unknown error",
        stack: error instanceof Error ? error.stack : undefined,
        user: userEmail,
        formData: data,
      });

      // Set specific error message
      const errorMsg =
        error instanceof Error
          ? error.message
          : "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      setErrorMessage(errorMsg);

      clearTimeout(timeoutId);
      setSubmitStatus("error");
      setIsSubmitting(false);
    }
  };

  if (submitStatus === "success") {
    return (
      <Card className="mx-auto w-full max-w-md">
        <CardContent className="pt-6">
          <div className="space-y-4 text-center">
            <CheckCircle className="text-green-500 mx-auto h-16 w-16" />
            <h3 className="text-gray-900 text-xl font-semibold">ì‹ ì²­ ì™„ë£Œ!</h3>
            <p className="text-gray-600">
              KYC ì‹ ì²­ì´ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤. ê²€í†  í›„ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.
            </p>
          </div>
        </CardContent>
      </Card>
    );
  }

  // Generate birth year options (1950-2010)
  const birthYears = Array.from({ length: 61 }, (_, i) => 1950 + i).reverse();

  return (
    <Card className="mx-auto w-full max-w-2xl">
      <CardHeader>
        <CardTitle className="text-center">ê³ ê°ë“±ë¡ ì‹ ì²­ì„œ</CardTitle>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
          {/* Privacy Consent */}
          <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-100 space-y-4 rounded-xl border p-6">
            <div className="flex items-center space-x-2">
              <div className="bg-blue-500 flex h-8 w-8 items-center justify-center rounded-full">
                <svg
                  className="h-5 w-5 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    strokeLinecap="round"
                    strokeLinejoin="round"
                    strokeWidth={2}
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
              </div>
              <h3 className="text-gray-800 text-lg font-semibold">
                ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš© ë™ì˜
              </h3>
            </div>
            <div className="text-gray-700 border-blue-200 space-y-3 rounded-lg border bg-white p-4 text-sm">
              <p className="flex items-start space-x-2">
                <span className="text-blue-500 font-medium">â€¢</span>
                <span>
                  ë³¸ ê³ ê°ë“±ë¡ ì‹ ì²­ì„œì— ê¸°ì…í•´ì£¼ì‹  ì •ë³´ëŠ” ë‹¹ì‚¬ì˜ ê³ ê° ê´€ë¦¬ ë°
                  ë‚´ë¶€ ìš´ì˜ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
                </span>
              </p>
              <p className="flex items-start space-x-2">
                <span className="text-blue-500 font-medium">â€¢</span>
                <span>
                  ì œì¶œí•´ì£¼ì‹  ì •ë³´ëŠ” ê´€ë ¨ ë²•ë ¹ì— ë”°ë¼ 3ë…„ê°„ ì•ˆì „í•˜ê²Œ ë³´ê´€ë˜ë©°,
                  ë³´ê´€ ê¸°ê°„ì´ ë§Œë£Œëœ í›„ì—ëŠ” ì¦‰ì‹œ íê¸°ë©ë‹ˆë‹¤.
                </span>
              </p>
              <p className="flex items-start space-x-2">
                <span className="text-blue-500 font-medium">â€¢</span>
                <span>
                  ë³¸ì¸ì€ ì´ì— ë™ì˜í•˜ë©°, ì œì¶œí•œ ì •ë³´ê°€ ë‚´ë¶€ ê´€ë¦¬ ëª©ì  ì™¸ì—ëŠ”
                  ì‚¬ìš©ë˜ì§€ ì•ŠìŒì„ í™•ì¸í•©ë‹ˆë‹¤.
                </span>
              </p>
            </div>
            <div className="border-blue-200 flex items-center space-x-3 rounded-lg border bg-white p-3">
              <input
                type="checkbox"
                id="privacyConsent"
                {...register("privacyConsent")}
                className="border-gray-300 text-blue-600 focus:ring-blue-500 h-5 w-5 rounded"
              />
              <Label
                htmlFor="privacyConsent"
                className="text-gray-700 text-sm font-medium"
              >
                ìœ„ ê°œì¸ì •ë³´ ìˆ˜ì§‘ ë° ì´ìš©ì— ë™ì˜í•©ë‹ˆë‹¤ *
              </Label>
            </div>
            {errors.privacyConsent && (
              <p className="text-red-500 bg-red-50 border-red-200 rounded border p-2 text-sm">
                {errors.privacyConsent.message}
              </p>
            )}
          </div>

          {/* Basic Information */}
          <div className="space-y-6 bg-gradient-to-r from-green-50 to-emerald-50 p-6 rounded-xl border border-green-100">
            <div className="flex items-center space-x-2">
              <div className="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
              </div>
              <h3 className="text-lg font-semibold text-gray-800">ê¸°ë³¸ ì •ë³´</h3>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">

            {/* Name */}
            <div className="space-y-2">
              <Label htmlFor="name">ì´ë¦„ *</Label>
              <Input
                id="name"
                {...register("name")}
                placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                className={cn(errors.name && "border-red-500")}
              />
              {errors.name && (
                <p className="text-red-500 text-sm">{errors.name.message}</p>
              )}
            </div>

            {/* Gender */}
            <div className="space-y-2">
              <Label>ì„±ë³„ *</Label>
              <RadioGroup
                onValueChange={(value) =>
                  setValue("gender", value as "male" | "female" | "other")
                }
                className="flex space-x-4"
              >
                <div className="flex items-center space-x-2">
                  <RadioGroupItem value="male" id="male" />
                  <Label htmlFor="male">ë‚¨ì„±</Label>
                </div>
                <div className="flex items-center space-x-2">
                  <RadioGroupItem value="female" id="female" />
                  <Label htmlFor="female">ì—¬ì„±</Label>
                </div>
                <div className="flex items-center space-x-2">
                  <RadioGroupItem value="other" id="other" />
                  <Label htmlFor="other">ê¸°íƒ€</Label>
                </div>
              </RadioGroup>
              {errors.gender && (
                <p className="text-red-500 text-sm">{errors.gender.message}</p>
              )}
            </div>

            {/* Birth Year */}
            <div className="space-y-2">
              <div className="flex items-center gap-2">
                <Label htmlFor="birthYear" className="text-gray-700 font-medium">ì¶œìƒë…„ë„ *</Label>
                <button
                  type="button"
                  className="w-5 h-5 bg-blue-100 hover:bg-blue-200 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold transition-colors duration-200"
                  onClick={() => alert("ë¯¸ì„±ë…„ì ì‘ì—… ë¶ˆê°€")}
                  title="ë¯¸ì„±ë…„ì ì‘ì—… ë¶ˆê°€"
                >
                  ?
                </button>
              </div>
              <select
                id="birthYear"
                {...register("birthYear")}
                className="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 transition-colors duration-200"
              >
                <option value="">ì¶œìƒë…„ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                {birthYears.map((year) => (
                  <option key={year} value={year.toString()}>
                    {year}ë…„
                  </option>
                ))}
              </select>
              {errors.birthYear && (
                <p className="text-red-500 text-sm bg-red-50 p-2 rounded border border-red-200">
                  {errors.birthYear.message}
                </p>
              )}
            </div>

            {/* Contact */}
            <div className="space-y-2">
              <Label htmlFor="contact" className="text-gray-700 font-medium">ì—°ë½ì²˜ *</Label>
              <Input
                id="contact"
                {...register("contact")}
                placeholder="ì—°ë½ì²˜ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 01012345678)"
                maxLength={11}
                className={cn(
                  "w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 transition-colors duration-200",
                  errors.contact && "border-red-500 focus:border-red-500 focus:ring-red-200"
                )}
                onChange={(e) => {
                  // ìˆ«ìë§Œ ì…ë ¥ í—ˆìš©
                  const value = e.target.value.replace(/[^0-9]/g, "");
                  e.target.value = value;
                  setValue("contact", value);
                }}
              />
              <p className="text-gray-500 text-sm">ìˆ«ìë§Œ ì…ë ¥í•˜ì„¸ìš”</p>
              {errors.contact && (
                <p className="text-red-500 text-sm bg-red-50 p-2 rounded border border-red-200">
                  {errors.contact.message}
                </p>
              )}
            </div>

            {/* Province and District */}
            <div className="space-y-2">
              <Label htmlFor="province" className="text-gray-700 font-medium">ì‹œë„ *</Label>
              <select
                id="province"
                {...register("province")}
                onChange={(e) => {
                  setValue(
                    "province",
                    e.target.value as "seoul" | "gyeonggi" | "incheon" | "other"
                  );
                  setValue("district", ""); // Reset district when province changes
                }}
                className={cn(
                  "w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 transition-colors duration-200",
                  errors.province && "border-red-500 focus:border-red-500 focus:ring-red-200"
                )}
              >
                <option value="">ì‹œë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                {provinces.map((province) => (
                  <option key={province.value} value={province.value}>
                    {province.label}
                  </option>
                ))}
              </select>
              {errors.province && (
                <p className="text-red-500 text-sm bg-red-50 p-2 rounded border border-red-200">
                  {errors.province.message}
                </p>
              )}
            </div>

            <div className="space-y-2">
              <Label htmlFor="district" className="text-gray-700 font-medium">ì‹œêµ°êµ¬ *</Label>
              <select
                id="district"
                {...register("district")}
                disabled={!watch("province")}
                className={cn(
                  "w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 transition-colors duration-200",
                  errors.district && "border-red-500 focus:border-red-500 focus:ring-red-200",
                  !watch("province") && "cursor-not-allowed opacity-50 bg-gray-50"
                )}
              >
                <option value="">ì‹œêµ°êµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                {watch("province") &&
                  districts[watch("province") as keyof typeof districts]?.map(
                    (district) => (
                      <option key={district.value} value={district.value}>
                        {district.label}
                      </option>
                    )
                  )}
              </select>
              {errors.district && (
                <p className="text-red-500 text-sm bg-red-50 p-2 rounded border border-red-200">
                  {errors.district.message}
                </p>
              )}
            </div>

            {/* Detailed Address */}
            <div className="space-y-2 md:col-span-2">
              <Label htmlFor="detailedAddress" className="text-gray-700 font-medium">ìƒì„¸ì£¼ì†Œ</Label>
              <Input
                id="detailedAddress"
                {...register("detailedAddress")}
                placeholder="ìƒì„¸ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)"
                className={cn(
                  "w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200 transition-colors duration-200",
                  errors.detailedAddress && "border-red-500 focus:border-red-500 focus:ring-red-200"
                )}
              />
              <p className="text-gray-500 text-sm">ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤</p>
              {errors.detailedAddress && (
                <p className="text-red-500 text-sm bg-red-50 p-2 rounded border border-red-200">
                  {errors.detailedAddress.message}
                </p>
              )}
            </div>
            </div> {/* Close grid */}
            </div> {/* Close Basic Information section */}

          {/* Skin Type and Treatment Info */}
          <div className="space-y-6 bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-xl border border-purple-100">
            <div className="flex items-center space-x-2">
              <div className="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center">
                <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                </svg>
              </div>
              <h3 className="text-lg font-semibold text-gray-800">í”¼ë¶€ ì •ë³´ ë° ì‹œìˆ  ê²½í—˜</h3>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {/* Skin Type */}
              <div className="space-y-3">
                <Label className="text-gray-700 font-medium">í”¼ë¶€íƒ€ì… *</Label>
                <RadioGroup
                  onValueChange={(value) =>
                    setValue(
                      "skinType",
                      value as
                        | "oily"
                        | "dry"
                        | "normal"
                        | "combination"
                        | "unknown"
                        | "other"
                    )
                  }
                  className="grid grid-cols-2 gap-3"
                >
                  <div className="flex items-center space-x-2 bg-white p-2 rounded-lg border border-gray-200">
                    <RadioGroupItem value="oily" id="oily" />
                    <Label htmlFor="oily" className="text-sm">ì§€ì„±</Label>
                  </div>
                  <div className="flex items-center space-x-2 bg-white p-2 rounded-lg border border-gray-200">
                    <RadioGroupItem value="dry" id="dry" />
                    <Label htmlFor="dry" className="text-sm">ê±´ì„±</Label>
                  </div>
                  <div className="flex items-center space-x-2 bg-white p-2 rounded-lg border border-gray-200">
                    <RadioGroupItem value="normal" id="normal" />
                    <Label htmlFor="normal" className="text-sm">ì¤‘ì„±</Label>
                  </div>
                  <div className="flex items-center space-x-2 bg-white p-2 rounded-lg border border-gray-200">
                    <RadioGroupItem value="combination" id="combination" />
                    <Label htmlFor="combination" className="text-sm">ë³µí•©ì„±</Label>
                  </div>
                  <div className="flex items-center space-x-2 bg-white p-2 rounded-lg border border-gray-200">
                    <RadioGroupItem value="unknown" id="unknown" />
                    <Label htmlFor="unknown" className="text-sm">ëª¨ë¥´ê² ìŒ</Label>
                  </div>
                  <div className="flex items-center space-x-2 bg-white p-2 rounded-lg border border-gray-200">
                    <RadioGroupItem value="other" id="other-skin" />
                    <Label htmlFor="other-skin" className="text-sm">ê¸°íƒ€</Label>
                  </div>
                </RadioGroup>
                {watch("skinType") === "other" && (
                  <div className="bg-blue-50 text-blue-700 rounded-lg p-3 text-sm border border-blue-200">
                    <p className="font-medium">íŠ¹ì´ ì²´ì§ˆì´ ìˆìœ¼ì‹œë‹¤ë©´ ê¸°íƒ€ì— ì ì–´ì£¼ì„¸ìš”</p>
                    <p className="text-blue-600">ì˜ˆ) ì¼ˆë¡œì´ë“œ, í”¼ë¶€ì—¼, ì•„í† í”¼ ë“±</p>
                  </div>
                )}
                {errors.skinType && (
                  <p className="text-red-500 text-sm bg-red-50 p-2 rounded border border-red-200">
                    {errors.skinType.message}
                  </p>
                )}
              </div>

              {/* Previous Treatment */}
              <div className="space-y-3">
                <Label className="text-gray-700 font-medium">ê¸°ì¡´ ì‹œìˆ  ì—¬ë¶€ *</Label>
                <RadioGroup
                  onValueChange={(value) =>
                    setValue("hasPreviousTreatment", value as "yes" | "no")
                  }
                  className="flex space-x-4"
                >
                  <div className="flex items-center space-x-2 bg-white p-2 rounded-lg border border-gray-200">
                    <RadioGroupItem value="yes" id="yes" />
                    <Label htmlFor="yes" className="text-sm">ìˆìŒ</Label>
                  </div>
                  <div className="flex items-center space-x-2 bg-white p-2 rounded-lg border border-gray-200">
                    <RadioGroupItem value="no" id="no" />
                    <Label htmlFor="no" className="text-sm">ì—†ìŒ</Label>
                  </div>
                </RadioGroup>
                {errors.hasPreviousTreatment && (
                  <p className="text-red-500 text-sm bg-red-50 p-2 rounded border border-red-200">
                    {errors.hasPreviousTreatment.message}
                  </p>
                )}
              </div>
            </div> {/* Close grid */}
            </div> {/* Close Skin Type and Treatment Info section */}
          </div>

          {/* Photo Upload Section */}
          <div className="space-y-4">
            <h3 className="text-lg font-semibold">í˜„ì¬ ëˆˆì¹ ì‚¬ì§„ *</h3>
            <p className="text-gray-600 text-sm">
              ì¢Œì¸¡, ì •ë©´, ìš°ì¸¡ ê°ê°ì˜ ì‚¬ì§„ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.
            </p>

            <div className="grid grid-cols-1 gap-4 md:grid-cols-3">
              {/* Left Photo */}
              <div className="space-y-2">
                <Label>ì¢Œì¸¡ ì‚¬ì§„</Label>
                <input
                  type="file"
                  accept="image/*"
                  onChange={handleFileChange("left")}
                  className="hidden"
                  id="left-photo"
                />
                <label
                  htmlFor="left-photo"
                  className={cn(
                    "block cursor-pointer rounded-lg border-2 border-dashed p-4 text-center transition-colors",
                    isDragging
                      ? "border-blue-500 bg-blue-50"
                      : "border-gray-300 hover:border-gray-400",
                    previewImages.left ? "border-green-500 bg-green-50" : ""
                  )}
                  onDrop={handleDrop("left")}
                  onDragOver={handleDragOver}
                  onDragLeave={handleDragLeave}
                >
                  {previewImages.left ? (
                    <div className="relative">
                      <Image
                        src={previewImages.left}
                        alt="ì¢Œì¸¡ ëˆˆì¹"
                        width={200}
                        height={200}
                        className="mx-auto rounded-lg object-cover"
                      />
                      <button
                        type="button"
                        onClick={(e) => {
                          e.preventDefault();
                          e.stopPropagation();
                          setPreviewImages((prev) => ({ ...prev, left: null }));
                          setSelectedFiles((prev) => ({ ...prev, left: null }));
                        }}
                        className="bg-red-500 hover:bg-red-600 absolute -top-2 -right-2 rounded-full p-1 text-white"
                      >
                        <X className="h-4 w-4" />
                      </button>
                    </div>
                  ) : (
                    <div className="space-y-2">
                      <ImagePlus className="text-gray-400 mx-auto h-8 w-8" />
                      <p className="text-gray-600 text-sm">
                        ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë˜ëŠ” í´ë¦­
                      </p>
                      <span className="text-blue-600 hover:text-blue-800 text-sm">
                        íŒŒì¼ ì„ íƒ
                      </span>
                    </div>
                  )}
                </label>
              </div>

              {/* Front Photo */}
              <div className="space-y-2">
                <Label>ì •ë©´ ì‚¬ì§„</Label>
                <input
                  type="file"
                  accept="image/*"
                  onChange={handleFileChange("front")}
                  className="hidden"
                  id="front-photo"
                />
                <label
                  htmlFor="front-photo"
                  className={cn(
                    "block cursor-pointer rounded-lg border-2 border-dashed p-4 text-center transition-colors",
                    isDragging
                      ? "border-blue-500 bg-blue-50"
                      : "border-gray-300 hover:border-gray-400",
                    previewImages.front ? "border-green-500 bg-green-50" : ""
                  )}
                  onDrop={handleDrop("front")}
                  onDragOver={handleDragOver}
                  onDragLeave={handleDragLeave}
                >
                  {previewImages.front ? (
                    <div className="relative">
                      <Image
                        src={previewImages.front}
                        alt="ì •ë©´ ëˆˆì¹"
                        width={200}
                        height={200}
                        className="mx-auto rounded-lg object-cover"
                      />
                      <button
                        type="button"
                        onClick={(e) => {
                          e.preventDefault();
                          e.stopPropagation();
                          setPreviewImages((prev) => ({
                            ...prev,
                            front: null,
                          }));
                          setSelectedFiles((prev) => ({
                            ...prev,
                            front: null,
                          }));
                        }}
                        className="bg-red-500 hover:bg-red-600 absolute -top-2 -right-2 rounded-full p-1 text-white"
                      >
                        <X className="h-4 w-4" />
                      </button>
                    </div>
                  ) : (
                    <div className="space-y-2">
                      <ImagePlus className="text-gray-400 mx-auto h-8 w-8" />
                      <p className="text-gray-600 text-sm">
                        ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë˜ëŠ” í´ë¦­
                      </p>
                      <span className="text-blue-600 hover:text-blue-800 text-sm">
                        íŒŒì¼ ì„ íƒ
                      </span>
                    </div>
                  )}
                </label>
              </div>

              {/* Right Photo */}
              <div className="space-y-2">
                <Label>ìš°ì¸¡ ì‚¬ì§„</Label>
                <input
                  type="file"
                  accept="image/*"
                  onChange={handleFileChange("right")}
                  className="hidden"
                  id="right-photo"
                />
                <label
                  htmlFor="right-photo"
                  className={cn(
                    "block cursor-pointer rounded-lg border-2 border-dashed p-4 text-center transition-colors",
                    isDragging
                      ? "border-blue-500 bg-blue-50"
                      : "border-gray-300 hover:border-gray-400",
                    previewImages.right ? "border-green-500 bg-green-50" : ""
                  )}
                  onDrop={handleDrop("right")}
                  onDragOver={handleDragOver}
                  onDragLeave={handleDragLeave}
                >
                  {previewImages.right ? (
                    <div className="relative">
                      <Image
                        src={previewImages.right}
                        alt="ìš°ì¸¡ ëˆˆì¹"
                        width={200}
                        height={200}
                        className="mx-auto rounded-lg object-cover"
                      />
                      <button
                        type="button"
                        onClick={(e) => {
                          e.preventDefault();
                          e.stopPropagation();
                          setPreviewImages((prev) => ({
                            ...prev,
                            right: null,
                          }));
                          setSelectedFiles((prev) => ({
                            ...prev,
                            right: null,
                          }));
                        }}
                        className="bg-red-500 hover:bg-red-600 absolute -top-2 -right-2 rounded-full p-1 text-white"
                      >
                        <X className="h-4 w-4" />
                      </button>
                    </div>
                  ) : (
                    <div className="space-y-2">
                      <ImagePlus className="text-gray-400 mx-auto h-8 w-8" />
                      <p className="text-gray-600 text-sm">
                        ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë˜ëŠ” í´ë¦­
                      </p>
                      <span className="text-blue-600 hover:text-blue-800 text-sm">
                        íŒŒì¼ ì„ íƒ
                      </span>
                    </div>
                  )}
                </label>
              </div>
            </div>
          </div>

          {/* Error Message */}
          {errorMessage && (
            <div className="bg-red-50 border-red-200 rounded-lg border p-4">
              <div className="flex items-center space-x-2">
                <AlertCircle className="text-red-500 h-5 w-5" />
                <p className="text-red-700">{errorMessage}</p>
              </div>
            </div>
          )}

          {/* Submit Button */}
          <Button type="submit" disabled={isSubmitting} className="w-full">
            {isSubmitting ? (
              <>
                <Loader2 className="animate-spin mr-2 h-4 w-4" />
                ì œì¶œ ì¤‘...
              </>
            ) : (
              "KYC ì‹ ì²­ ì œì¶œ"
            )}
          </Button>
        </form>
      </CardContent>
    </Card>
  );
}
